# WordPress REST API Client

## Overview

This WordPress API client fetches blog posts from the WordPress site (`https://wp.saabuildingblocks.com`) using Basic Authentication with Application Passwords. It's designed for use during Next.js build time with React's `cache` function for optimal performance.

## Files

- **`api.ts`** - Main API client with fetch functions
- **`types.ts`** - TypeScript type definitions
- **`README.md`** - This documentation

## Setup

### 1. Environment Variables

Add to `/home/claude-flow/nextjs-frontend/.env.local`:

```env
# WordPress REST API Configuration
WORDPRESS_URL=https://wp.saabuildingblocks.com
WORDPRESS_USER=your-wordpress-username
WORDPRESS_APP_PASSWORD=your-application-password-here
```

### 2. Generate WordPress Application Password

1. Log in to WordPress admin (`https://wp.saabuildingblocks.com/wp-admin`)
2. Go to Users → Profile
3. Scroll to "Application Passwords" section
4. Enter a name (e.g., "Next.js Build")
5. Click "Add New Application Password"
6. Copy the generated password (format: `xxxx xxxx xxxx xxxx xxxx xxxx`)
7. Paste into `.env.local` as `WORDPRESS_APP_PASSWORD` (remove spaces)

### 3. Test Connection

```bash
# Run API test script
node scripts/test-wordpress-api.js
```

This will:
- ✅ Verify credentials are configured
- ✅ Test API connectivity
- ✅ Analyze category distribution
- ✅ Check featured images
- ✅ Verify author data

## Usage

### Fetch All Posts

```typescript
import { fetchAllPosts } from '@/lib/wordpress/api';

// In a Server Component or during build
const posts = await fetchAllPosts();

// Automatically filters by allowed categories:
// - about-exp
// - agent-career-info
// - exp-realty-sponsor
// - fun-for-agents
// - industry-trends
// - marketing-mastery
// - winning-clients
```

### Fetch Single Post by Slug

```typescript
import { fetchPostBySlug } from '@/lib/wordpress/api';

const post = await fetchPostBySlug('my-post-slug');

if (!post) {
  // Post not found or not in allowed categories
  notFound();
}
```

### Fetch by Category

```typescript
import { fetchPostsByCategory } from '@/lib/wordpress/api';

const posts = await fetchPostsByCategory('industry-trends');
```

### Get Allowed Categories

```typescript
import { getAllowedCategories } from '@/lib/wordpress/api';

const categories = getAllowedCategories();
// ['about-exp', 'agent-career-info', ...]
```

### Check Configuration

```typescript
import { isWordPressConfigured } from '@/lib/wordpress/api';

if (!isWordPressConfigured()) {
  console.error('WordPress credentials not configured');
}
```

## Data Structure

### BlogPost Type

```typescript
interface BlogPost {
  id: number;
  slug: string;
  title: string;
  content: string;          // Rendered HTML
  excerpt: string;          // Rendered HTML
  date: string;             // ISO 8601 format
  modified: string;         // ISO 8601 format
  featuredImage?: {
    url: string;
    alt: string;
    width: number;
    height: number;
  };
  author: {
    name: string;
    avatar?: string;        // URL to 96x96 avatar
  };
  categories: string[];     // Category slugs
}
```

## Category Filtering

The client automatically filters posts to only include those in allowed categories:

1. **About eXp** → `about-exp`
2. **Agent Career Info** → `agent-career-info`
3. **eXp Realty Sponsor** → `exp-realty-sponsor`
4. **Fun For Agents** → `fun-for-agents`
5. **Industry Trends** → `industry-trends`
6. **Marketing Mastery** → `marketing-mastery`
7. **Winning Clients** → `winning-clients`

Posts outside these categories are excluded from results.

## Caching Strategy

### Build-Time (Production)

```typescript
next: {
  revalidate: false  // No revalidation in production
}
```

Posts are fetched once during build and cached permanently. To update content:

```bash
npm run build  # Rebuild to fetch latest posts
```

### Development Mode

```typescript
next: {
  revalidate: 300  // Revalidate every 5 minutes
}
```

Posts are refetched every 5 minutes during development for easier testing.

## Authentication

### Basic Auth Header

```typescript
// Automatically generated by createAuthHeader()
const credentials = `${WORDPRESS_USER}:${WORDPRESS_APP_PASSWORD}`;
const authHeader = 'Basic ' + Buffer.from(credentials).toString('base64');
```

### Security Notes

- ✅ Application Passwords are more secure than regular passwords
- ✅ Can be revoked without changing account password
- ✅ Scoped to API access only
- ⚠️ Never commit `.env.local` to git
- ⚠️ Use environment variables in production

## Error Handling

### Missing Credentials

```typescript
// Throws error if WORDPRESS_USER or WORDPRESS_APP_PASSWORD not set
Error: WordPress credentials not configured. Set WORDPRESS_USER and WORDPRESS_APP_PASSWORD in .env.local
```

### API Errors

```typescript
// Throws error with detailed status and message
Error: WordPress API error: 401 Unauthorized. Invalid credentials
Error: WordPress API error: 404 Not Found. Endpoint not found
```

### Not Found

```typescript
// fetchPostBySlug returns null if post not found
const post = await fetchPostBySlug('nonexistent');
// post === null
```

## WordPress REST API Reference

### Endpoints Used

```
GET /wp-json/wp/v2/posts?_embed&per_page=100&status=publish
GET /wp-json/wp/v2/posts?slug={slug}&_embed
```

### Query Parameters

- `_embed` - Include embedded data (media, terms, author)
- `per_page=100` - Fetch up to 100 posts
- `status=publish` - Only published posts
- `slug={slug}` - Filter by post slug

### Embedded Data

The `_embed` parameter includes:

- **wp:featuredmedia** - Featured image data
- **wp:term** - Categories and tags
- **author** - Author details with avatar

## Troubleshooting

### Error: 401 Unauthorized

**Cause:** Invalid credentials

**Fix:**
1. Verify `WORDPRESS_USER` matches WordPress username
2. Regenerate Application Password
3. Ensure no spaces in password (WordPress shows with spaces, remove them)

### Error: 403 Forbidden

**Cause:** User lacks permissions

**Fix:**
1. Ensure user has "Editor" or "Administrator" role
2. Check Application Password is active
3. Verify REST API is enabled in WordPress

### Error: Connection Refused

**Cause:** WordPress site unreachable

**Fix:**
1. Verify `WORDPRESS_URL` is correct
2. Check WordPress site is running
3. Test URL in browser: `https://wp.saabuildingblocks.com/wp-json`

### No Posts Returned

**Cause:** Category filtering or no published posts

**Fix:**
1. Check WordPress has published posts
2. Verify posts are in allowed categories
3. Run test script to see category distribution
4. Adjust `ALLOWED_CATEGORIES` if needed

## Development Workflow

### 1. Initial Setup

```bash
# Copy environment template
cp .env.local.example .env.local

# Edit with real credentials
nano .env.local

# Test connection
node scripts/test-wordpress-api.js
```

### 2. Development

```bash
# Start dev server (fetches posts every 5 minutes)
npm run dev
```

### 3. Production Build

```bash
# Build with fresh post data
npm run build

# Start production server
npm start
```

## Integration Example

### Blog Index Page

```typescript
// app/blog/page.tsx
import { fetchAllPosts } from '@/lib/wordpress/api';

export default async function BlogPage() {
  const posts = await fetchAllPosts();

  return (
    <div>
      <h1>Blog</h1>
      {posts.map(post => (
        <article key={post.id}>
          <h2>{post.title}</h2>
          <div dangerouslySetInnerHTML={{ __html: post.excerpt }} />
        </article>
      ))}
    </div>
  );
}
```

### Single Post Page

```typescript
// app/blog/[slug]/page.tsx
import { fetchPostBySlug, fetchAllPosts } from '@/lib/wordpress/api';
import { notFound } from 'next/navigation';

export async function generateStaticParams() {
  const posts = await fetchAllPosts();
  return posts.map(post => ({ slug: post.slug }));
}

export default async function PostPage({ params }: { params: { slug: string } }) {
  const post = await fetchPostBySlug(params.slug);

  if (!post) {
    notFound();
  }

  return (
    <article>
      <h1>{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: post.content }} />
    </article>
  );
}
```

## Performance Considerations

### Build Time

- ✅ React `cache()` prevents duplicate fetches
- ✅ Single API call fetches all posts
- ✅ Category filtering happens in-memory

### Bundle Size

- ✅ Client-side bundle includes zero WordPress code
- ✅ All fetching happens server-side
- ✅ Types are stripped during build

### Network Requests

- ✅ Production: 1 request per build
- ✅ Development: 1 request per 5 minutes
- ✅ Individual posts: Cached from initial fetch

## Next Steps

1. ✅ **Test API Connection** - Run `node scripts/test-wordpress-api.js`
2. ⏳ **Create Blog Pages** - Build `/blog` index and `[slug]` pages
3. ⏳ **Add Styling** - Apply SAA design system
4. ⏳ **Implement ISR** - Add Incremental Static Regeneration if needed
5. ⏳ **Add Pagination** - Handle large post counts
6. ⏳ **Category Pages** - Create `/blog/category/[slug]` routes
