<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName saabuildingblocks.com
    ServerAlias www.saabuildingblocks.com
    Protocols h2 http/1.1

    # SSL Configuration
    SSLEngine on
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Let's Encrypt ACME challenge must bypass proxy
    <Location "/.well-known/acme-challenge/">
        Satisfy any
        Require all granted
        ProxyPass !
    </Location>

    # Allow Next.js static assets without authentication
    <LocationMatch "^/_next/(static|image|data)/">
        Satisfy any
        Require all granted
    </LocationMatch>

    # Allow public static files without authentication
    <LocationMatch "^/(fonts|images|games|icon\.svg|apple-touch-icon\.png|favicon\.ico)">
        Satisfy any
        Require all granted
    </LocationMatch>

    # Allow API routes without authentication (for client-side API calls)
    <LocationMatch "^/api/">
        Satisfy any
        Require all granted
    </LocationMatch>

    # Site is now publicly accessible (Basic Auth removed)
    # Authentication is handled by Next.js application-level logic

    # Proxy to Next.js application
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:3002/
    ProxyPassReverse / http://127.0.0.1:3002/


    # Logging
    ErrorLog ${APACHE_LOG_DIR}/saabuildingblocks_nextjs_error.log
    CustomLog ${APACHE_LOG_DIR}/saabuildingblocks_nextjs_access.log combined
    SSLCertificateFile /etc/letsencrypt/live/saabuildingblocks.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/saabuildingblocks.com/privkey.pem
</VirtualHost>
</IfModule>
