name: Turbopack Compatibility Check

# Runs monthly to check if Turbopack is now compatible with Tailwind CSS v4
on:
  schedule:
    # Run on the 1st of every month at 9 AM UTC
    - cron: '0 9 1 * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-turbopack:
    name: Test Turbopack Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate static CSS
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd packages/public-site
          npm run generate:css || echo "CSS generation failed, but continuing test"

      - name: Test Build with Turbopack (ENABLED)
        id: turbopack-test
        env:
          NODE_ENV: production
          # Do NOT set TURBOPACK=0 - we want to test with Turbopack enabled
          NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsYWNlaG9sZGVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzUyNjUyMDAsImV4cCI6MTk5MDg0MTIwMH0.cXVhY2toIHdvcmthcm91bmQ"
        run: |
          cd packages/public-site

          echo "üß™ Testing if Turbopack is now compatible with Tailwind CSS v4..."
          echo ""

          if npx next build 2>&1 | tee build.log; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ SUCCESS! Turbopack build completed without errors!"
            echo ""
            echo "üéâ Turbopack is now compatible with Tailwind CSS v4!"
            echo "üìù You can now re-enable Turbopack by removing TURBOPACK=0 from deploy-cloudflare.yml"
            exit 0
          else
            # Check if it's the specific CSS error we're watching for
            if grep -q "Can't resolve '...'" build.log; then
              echo "result=still-broken" >> $GITHUB_OUTPUT
              echo ""
              echo "‚ùå Still broken: Same CSS module resolution error"
              echo ""
              echo "Turbopack is still incompatible with Tailwind CSS v4."
              echo "Will check again next month."
              exit 0
            else
              echo "result=different-error" >> $GITHUB_OUTPUT
              echo ""
              echo "‚ö†Ô∏è  Build failed with a DIFFERENT error!"
              echo "This may require investigation."
              exit 1
            fi
          fi

      - name: Create Issue if Turbopack is Compatible
        if: steps.turbopack-test.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üéâ Turbopack is now compatible with Tailwind CSS v4!';
            const body = `## Turbopack Compatibility Restored

            The monthly compatibility check has detected that Turbopack can now successfully build with Tailwind CSS v4!

            ### Next Steps

            1. Remove \`TURBOPACK: "0"\` from \`.github/workflows/deploy-cloudflare.yml\` (line 113)
            2. Test locally: \`NODE_ENV=production npx next build\`
            3. Deploy and verify
            4. Delete \`packages/public-site/.github/TURBOPACK_CHECK.md\`
            5. Close this issue
            6. Optionally disable this workflow

            ### Build Log

            Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            ---

            ü§ñ Auto-generated by monthly Turbopack compatibility check
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['enhancement', 'automated']
            });
