name: Deploy to Cloudflare Pages

"on":
  # Trigger from n8n workflow
  repository_dispatch:
    types: [deploy-wordpress-content]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      post_id:
        description: 'WordPress Post ID'
        required: false
      post_slug:
        description: 'WordPress Post Slug'
        required: false
      deployment_type:
        description: 'Deployment type'
        required: false
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      deployment_id:
        description: 'WordPress Deployment ID'
        required: false
      triggered_by:
        description: 'Trigger source'
        required: false
        default: 'manual'

env:
  NODE_VERSION: '20'
  CLOUDFLARE_PROJECT_NAME: 'saabuildingblocks'  # Static export project
  DEPLOYMENT_TIMEOUT: 900  # 15 minutes in seconds
  MAX_PARALLEL_UPLOADS: 100  # Increased from 50 for faster uploads
  RETRY_ATTEMPTS: 3
  RETRY_DELAY: 2  # Reduced from 5s to 2s for faster retries

jobs:
  # Build job - creates the static export
  build:
    name: Build Static Export
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      build-hash: ${{ steps.compute-hash.outputs.build-hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits for change detection
          token: ${{ secrets.GITHUB_TOKEN }}

      # Auto-commit any pending CSS changes from "Update Static Files" button
      - name: Commit pending CSS changes
        run: |
          echo "ðŸ” Checking for uncommitted CSS changes..."

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if CSS file has changes
          if git diff --quiet packages/public-site/public/static-master-controller.css; then
            echo "âœ… No CSS changes to commit"
          else
            echo "ðŸ“ Found uncommitted CSS changes, committing..."

            # Get timestamp from CSS file
            CSS_TIMESTAMP=$(grep "Generated:" packages/public-site/public/static-master-controller.css | head -1 | sed 's/.*Generated: //' | sed 's/ \*$//')

            git add packages/public-site/public/static-master-controller.css
            git commit -m "chore: Update static CSS from Master Controller

            Generated: ${CSS_TIMESTAMP}
            Source: Database (Supabase)
            Triggered by: Deploy to Cloudflare workflow"

            git push

            echo "âœ… CSS changes committed and pushed"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Caching disabled for guaranteed fresh builds

      # Install dependencies (monorepo root) - always fresh install
      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies (fresh install - caching disabled)..."
          npm ci --prefer-offline --no-audit

      # NEW: Type check BEFORE building to catch ALL errors at once
      - name: Type Check (Catch all errors upfront)
        run: |
          echo "ðŸ” Running TypeScript type check..."
          echo "   This will show ALL type errors at once (not just the first one)"
          echo ""
          
          cd packages/public-site
          npm run type-check || {
            echo ""
            echo "âŒ Type errors found above. Fix these before the build will succeed."
            exit 1
          }
          
          echo "âœ… Type check passed"

      # Verify static CSS exists (should be committed via "Update Static Files" button)
      - name: Verify static CSS file
        run: |
          cd packages/public-site

          if [ -f "public/static-master-controller.css" ]; then
            echo "âœ… Static CSS file found (committed from Update Static Files)"
            ls -lh public/static-master-controller.css
          else
            echo "âŒ Static CSS file not found!"
            echo "   Please click 'Update Static Files' button first to generate and commit CSS"
            exit 1
          fi

      # Build static export (FROM MONOREPO ROOT - fixes tsconfig resolution)
      - name: Build Static Export
        env:
          NODE_ENV: production
          # Use properly formatted placeholder values (API routes excluded from export)
          NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsYWNlaG9sZGVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzUyNjUyMDAsImV4cCI6MTk5MDg0MTIwMH0.cXVhY2toIHdvcmthcm91bmQ"
          SUPABASE_SERVICE_ROLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsYWNlaG9sZGVyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY3NTI2NTIwMCwiZXhwIjoxOTkwODQxMjAwfQ.c2VydmljZSByb2xlIGtleQ"
          # WordPress API for blog content
          WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL }}
          NEXT_PUBLIC_WORDPRESS_API_URL: ${{ secrets.NEXT_PUBLIC_WORDPRESS_API_URL }}
          # WordPress credentials for authenticated API access
          WORDPRESS_USER: ${{ secrets.WORDPRESS_USER }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
        run: |
          echo "ðŸ”¨ Building static export for Cloudflare Pages"
          echo "   Config: next.config.ts (already has output: 'export')"
          echo "   Build context: Monorepo root (fixes tsconfig resolution)"
          echo "   âœ… FIXED: Turbopack can now resolve '../../tsconfig.json'"
          echo ""

          # cd into package directory and build
          cd packages/public-site
          npx next build

          # Quick verification
          [ -d "out/_next" ] && [ -f "out/index.html" ] || { echo "âŒ Build failed"; exit 1; }
          echo "âœ… Build complete: $(find out -type f | wc -l) files, $(du -sh out/ | cut -f1)"

      # Compute simple build hash (for tracking only)
      - name: Compute build hash
        id: compute-hash
        working-directory: packages/public-site
        run: |
          # Simple hash based on commit + build time (no per-file hashing needed)
          BUILD_HASH="${{ github.sha }}-$(date +%s)"
          echo "build-hash=${BUILD_HASH}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Build: ${BUILD_HASH}"

      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: packages/public-site/out
          retention-days: 7
          compression-level: 6

  # Deploy job - uploads to Cloudflare
  deploy:
    name: Deploy to Cloudflare Pages
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: packages/public-site/out

      # Setup Node.js (caching disabled for guaranteed fresh builds)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Install Wrangler globally
      - name: Install Wrangler
        run: |
          if ! command -v wrangler &> /dev/null; then
            echo "ðŸ“¦ Installing Wrangler..."
            npm install -g wrangler@latest
          else
            echo "âœ… Wrangler already installed: $(wrangler --version)"
          fi

      # Deploy to Cloudflare Pages with retry logic
      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Retry logic in bash (simpler than multiple workflow steps)
          for attempt in 1 2 3; do
            echo "ðŸš€ Deployment attempt $attempt/3..."
            if wrangler pages deploy packages/public-site/out --project-name=saabuildingblocks --branch=main --commit-dirty=true; then
              echo "âœ… Deployment successful on attempt $attempt"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            [ $attempt -lt 3 ] && echo "â³ Retrying in 2s..." && sleep 2
          done
          echo "âŒ Deployment failed after 3 attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1


  # Notification job - sends webhook to n8n
  notify:
    name: Send Deployment Notification
    needs: [build, deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: always()

    steps:
      - name: Prepare notification payload
        id: prepare-payload
        run: |
          # Get status from deploy job output
          DEPLOY_RESULT="${{ needs.deploy.result }}"

          if [ "$DEPLOY_RESULT" = "success" ]; then
            STATUS="success"
            MESSAGE="âœ… Deployment completed successfully"
          elif [ "$DEPLOY_RESULT" = "failure" ]; then
            STATUS="failed"
            MESSAGE="âŒ Deployment failed"
          elif [ "$DEPLOY_RESULT" = "skipped" ]; then
            STATUS="skipped"
            MESSAGE="â­ï¸  Deployment skipped"
          else
            STATUS="cancelled"
            MESSAGE="ðŸš« Deployment cancelled"
          fi
          
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "message=${MESSAGE}" >> $GITHUB_OUTPUT
          
          # Create JSON payload
          cat > payload.json <<EOF
          {
            "status": "${STATUS}",
            "message": "${MESSAGE}",
            "post_id": "${{ github.event.client_payload.post_id || inputs.post_id || '' }}",
            "post_slug": "${{ github.event.client_payload.post_slug || inputs.post_slug || '' }}",
            "deployment_url": "https://saabuildingblocks.pages.dev",
            "production_url": "https://static.smartagentalliance.com",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "build_hash": "${{ needs.build.outputs.build-hash }}",
            "triggered_by": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "timestamp": "$(date -Iseconds)"
          }
          EOF
          
          echo "ðŸ“ Notification payload prepared"
          cat payload.json

      # Send notification to n8n webhook
      - name: Send notification webhook
        continue-on-error: true
        run: |
          echo "ðŸ“¤ Sending notification to n8n webhook..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.N8N_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d @payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  Notification failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          fi

      # Send status back to WordPress
      - name: Notify WordPress
        if: always()
        continue-on-error: true
        run: |
          DEPLOYMENT_ID="${{ github.event.inputs.deployment_id }}"
          STATUS="${{ steps.prepare-payload.outputs.status }}"
          
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "â„¹ï¸  No deployment ID provided, skipping WordPress notification"
            exit 0
          fi
          
          echo "ðŸ“¤ Sending deployment status to WordPress..."
          echo "   Deployment ID: $DEPLOYMENT_ID"
          echo "   Status: $STATUS"
          
          # Prepare error message if deployment failed
          ERROR_MESSAGE=""
          if [ "$STATUS" = "failed" ]; then
            ERROR_MESSAGE="Deployment failed after 3 attempts. Check GitHub Actions logs for details."
          fi
          
          # Send webhook to WordPress
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.WORDPRESS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "deployment_id": "'"$DEPLOYMENT_ID"'",
              "status": "'"$STATUS"'",
              "build_hash": "${{ needs.build.outputs.build-hash }}",
              "github_run_id": "${{ github.run_id }}",
              "github_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "cloudflare_deployment_url": "https://saabuildingblocks.pages.dev",
              "commit_sha": "${{ github.sha }}",
              "error_message": "'"$ERROR_MESSAGE"'",
              "timestamp": "'"$(date -Iseconds)"'"
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… WordPress notified successfully (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  WordPress notification failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          fi

      # Create GitHub deployment status
      - name: Update GitHub deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.prepare-payload.outputs.status }}';
            const message = '${{ steps.prepare-payload.outputs.message }}';
            
            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: status === 'success' ? 'success' : status === 'failed' ? 'failure' : 'inactive',
              description: message,
              environment_url: 'https://static.smartagentalliance.com',
              log_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            }).catch(err => {
              console.log('Note: Could not create deployment status (no deployment found)');
            });
            
            // Add comment to commit with deployment status
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `
            ## ðŸš€ Cloudflare Deployment ${status === 'success' ? 'âœ…' : 'âŒ'}
            
            **Status:** ${message}
            **Build Hash:** \`${{ needs.build.outputs.build-hash }}\`
            **Deployment URL:** https://saabuildingblocks.pages.dev
            **Production URL:** https://static.smartagentalliance.com
            **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ${status === 'failed' ? 'âš ï¸ Check the workflow logs for error details.' : ''}
              `.trim()
            }).catch(err => {
              console.log('Note: Could not create commit comment');
            });
